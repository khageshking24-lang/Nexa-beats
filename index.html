<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>MALHOTRA CLASSES | Pro v17.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0b0e14; color: #fff; }
        .nexa-glass { background: #151921; border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; }
        .tab-content { display: none; }
        .active-tab { display: block; animation: slideUp 0.3s ease; }
        input, select, textarea { background: #1e232d !important; border: 1px solid #2d3545 !important; color: #fff !important; padding: 12px !important; border-radius: 12px !important; width: 100%; outline: none; transition: 0.3s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .btn-gradient { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    </style>
</head>
<body>

<div id="lockScreen" class="fixed inset-0 z-[9999] bg-[#0b0e14] flex items-center justify-center p-6 text-center">
    <div class="nexa-glass p-8 w-full max-w-sm border-t-4 border-indigo-600 shadow-2xl">
        <h2 class="text-2xl font-black text-indigo-500 italic mb-1 uppercase">Malhotra Classes</h2>
        <p class="text-[9px] text-slate-500 mb-8 uppercase font-bold tracking-widest italic">v17.2 Pro ERP | Khagesh ai-nexa</p>
        <div class="space-y-4">
            <input type="password" id="mKey" placeholder="Activation Key" class="text-center font-bold">
            <button onclick="unlockApp()" class="w-full btn-gradient py-4 rounded-xl font-black uppercase text-xs shadow-lg">Activate Premium</button>
            <button onclick="enterApp()" class="w-full bg-slate-800 border border-slate-700 py-4 rounded-xl font-black uppercase text-[10px] text-indigo-400 mt-2">Continue 7-Day Trial</button>
        </div>
    </div>
</div>

<div id="appUI" class="p-4 max-w-lg mx-auto pb-40" style="display: none;">
    <header class="py-6 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black text-indigo-500 italic leading-none">MALHOTRA CLASSES</h1>
            <p class="text-[7px] text-slate-500 font-bold uppercase tracking-widest">Sant Nagar Burari, Delhi-84</p>
            <p class="text-[8px] text-indigo-400/50 font-bold uppercase mt-1 italic">Powered by Khagesh ai-nexa</p>
        </div>
        <div class="flex gap-2">
            <label title="Import Data" class="w-9 h-9 nexa-glass text-emerald-400 flex items-center justify-center text-xs cursor-pointer"><i class="fas fa-file-import"></i><input type="file" class="hidden" onchange="importData(this)"></label>
            <button onclick="masterReset()" title="Reset System" class="w-9 h-9 nexa-glass text-red-500 flex items-center justify-center text-xs"><i class="fas fa-sync-alt"></i></button>
        </div>
    </header>

    <div id="t-home" class="tab-content active-tab space-y-4">
        <div class="relative"><input type="text" id="hSearch" onkeyup="renderHome()" placeholder="Search Name, Batch, School..." class="pl-11 text-xs"><i class="fas fa-search absolute left-4 top-4 text-slate-600 text-xs"></i></div>
        <div id="hList" class="space-y-3"></div>
    </div>

    <div id="t-add" class="tab-content space-y-4">
        <div class="nexa-glass p-6 space-y-3 border-t-2 border-indigo-600 shadow-2xl">
            <h3 class="text-[10px] font-black text-indigo-400 uppercase italic mb-2">Student Admission</h3>
            <input type="text" id="inN" placeholder="Full Name">
            <input type="text" id="inS" placeholder="School Name (New Feature)">
            <div class="grid grid-cols-2 gap-2"><input type="text" id="inB" placeholder="Batch (e.g. 4-5 PM)"><input type="text" id="inC" placeholder="Subject"></div>
            <div class="grid grid-cols-2 gap-2"><input type="number" id="inF" placeholder="Fee Amount"><input type="number" id="inP" placeholder="Phone Number"></div>
            <div class="flex flex-col gap-1"><label class="text-[8px] text-slate-500 uppercase font-black ml-1">Joined Date</label><input type="date" id="inD"></div>
            <button onclick="saveStudent()" class="w-full btn-gradient py-4 rounded-xl font-black uppercase italic mt-2">Confirm Admission</button>
        </div>
    </div>

    <div id="t-att" class="tab-content space-y-4">
        <div class="nexa-glass p-5">
            <select id="attBatch" onchange="loadAtt()" class="mb-4 text-xs font-bold text-indigo-400"></select>
            <div id="atList" class="space-y-2 mb-4 max-h-80 overflow-y-auto"></div>
            <button onclick="saveAtt()" class="w-full btn-gradient py-4 rounded-xl font-black uppercase text-xs">Lock Daily Attendance</button>
        </div>
    </div>

    <div id="t-fees" class="tab-content space-y-4">
        <div class="nexa-glass p-5 space-y-4">
            <div class="p-4 bg-indigo-600/10 rounded-xl border border-indigo-500/20">
                <h4 class="text-[9px] font-black uppercase text-indigo-400 mb-2">Edit Fee Message Template</h4>
                <textarea id="waMsg" rows="3" class="text-[11px] leading-relaxed">Dear {name}, your monthly fee of ₹{fee} is pending at MALHOTRA CLASSES. Kindly clear it at the earliest. - Khagesh ai-nexa</textarea>
            </div>
            <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
                <label class="text-emerald-400 text-[9px] font-black uppercase cursor-pointer flex items-center gap-2">
                    <i class="fas fa-file-excel"></i> Upload Bulk Excel <input type="file" class="hidden" onchange="bulkWAExcel(this)">
                </label>
                <button onclick="waBulkSelected()" class="text-indigo-400 text-[9px] font-black uppercase">Send Selected</button>
            </div>
            <div id="fList" class="space-y-2"></div>
        </div>
    </div>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] nexa-glass p-2 flex justify-around shadow-2xl z-50 backdrop-blur-xl border-white/10">
        <button onclick="nav('home', this)" class="p-4 text-indigo-500"><i class="fas fa-home"></i></button>
        <button onclick="nav('add', this)" class="p-4 text-slate-500"><i class="fas fa-user-plus"></i></button>
        <button onclick="nav('att', this)" class="p-4 text-slate-500"><i class="fas fa-calendar-check"></i></button>
        <button onclick="nav('fees', this)" class="p-4 text-slate-500"><i class="fas fa-receipt"></i></button>
    </nav>
</div>

<script>
    const MASTER_KEY = "Permanentkey63793119";
    let db, students = [], attData = {};

    function unlockApp() { if(document.getElementById("mKey").value === MASTER_KEY) { localStorage.setItem("mal_premium", "true"); enterApp(); } else alert("Invalid Key!"); }
    function enterApp() { document.getElementById("lockScreen").style.display = "none"; document.getElementById("appUI").style.display = "block"; initDB(); }

    function initDB() {
        const req = indexedDB.open("MalhotraERP_v17_Pro", 1);
        req.onupgradeneeded = e => { db = e.target.result; db.createObjectStore("st", {keyPath: "id"}); db.createObjectStore("at", {keyPath: "date"}); };
        req.onsuccess = e => { db = e.target.result; sync(); if(navigator.storage && navigator.storage.persist) navigator.storage.persist(); };
    }

    function sync() {
        const tx = db.transaction(["st", "at"], "readonly");
        tx.objectStore("st").getAll().onsuccess = e => { students = e.target.result; updateUI(); };
        tx.objectStore("at").getAll().onsuccess = e => { e.target.result.forEach(r => attData[r.date] = r.data); loadAtt(); };
    }

    function updateUI() {
        const batches = [...new Set(students.map(s => s.batch))];
        document.getElementById("attBatch").innerHTML = '<option value="">Filter by Batch (All)</option>' + batches.map(b => `<option value="${b}">${b}</option>`).join("");
        renderHome(); renderFees();
    }

    function renderHome() {
        const q = document.getElementById("hSearch").value.toLowerCase();
        const filt = students.filter(s => s.name.toLowerCase().includes(q) || s.batch.toLowerCase().includes(q) || (s.school && s.school.toLowerCase().includes(q)));
        document.getElementById("hList").innerHTML = filt.map(s => `
            <div class="nexa-glass p-5 flex justify-between items-center border-l-4 border-indigo-500 shadow-lg">
                <div>
                    <p class="font-black text-sm uppercase italic leading-none">${s.name}</p>
                    <p class="text-[9px] text-slate-500 font-bold uppercase mt-1">${s.batch} | ${s.school || 'Private'}</p>
                    <p class="text-[8px] text-indigo-400 font-black mt-1 italic uppercase">Joined: ${s.date || 'N/A'}</p>
                </div>
                <div class="flex gap-1">
                    <button onclick="migrateStudent(${s.id})" title="Change Batch" class="w-8 h-8 nexa-glass flex items-center justify-center text-indigo-400 text-[10px]"><i class="fas fa-exchange-alt"></i></button>
                    <a href="tel:${s.phone}" class="w-8 h-8 nexa-glass flex items-center justify-center text-blue-400 text-[10px]"><i class="fas fa-phone-alt"></i></a>
                    <button onclick="delSt(${s.id})" class="w-8 h-8 nexa-glass flex items-center justify-center text-red-500 text-[10px]"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`).join("");
    }

    function saveStudent() {
        const s = { id: Date.now(), name: document.getElementById("inN").value, school: document.getElementById("inS").value, batch: document.getElementById("inB").value, cls: document.getElementById("inC").value, fee: document.getElementById("inF").value, phone: document.getElementById("inP").value, date: document.getElementById("inD").value || new Date().toISOString().split('T')[0] };
        if(!s.name || !s.phone) return alert("Name and Phone required!");
        const tx = db.transaction("st", "readwrite"); tx.objectStore("st").add(s);
        tx.oncomplete = () => { sync(); alert("Admission Saved!"); ["inN","inS","inB","inC","inF","inP","inD"].forEach(i => document.getElementById(i).value=""); };
    }

    function migrateStudent(id) {
        const s = students.find(x => x.id == id);
        const newBatch = prompt("Transfer student to which batch?", s.batch);
        if(newBatch) { s.batch = newBatch; const tx = db.transaction("st", "readwrite"); tx.objectStore("st").put(s); tx.oncomplete = () => sync(); }
    }

    function importData(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            const wb = XLSX.read(e.target.result, {type: 'binary'});
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const list = raw.map(row => ({
                id: row.id || Date.now() + Math.random(),
                name: row.name || "N/A",
                school: row.school || "Private",
                batch: row.batch || "General",
                fee: row.fee || 0,
                phone: row.phone || row['__EMPTY'] || row.mobile || "",
                date: row.date || new Date().toISOString().split('T')[0]
            }));
            const tx = db.transaction("st", "readwrite");
            list.forEach(s => tx.objectStore("st").put(s));
            tx.oncomplete = () => { alert(list.length + " Students Imported Successfully!"); sync(); };
        };
        reader.readAsBinaryString(input.files[0]);
    }

    function bulkWAExcel(input) {
        const reader = new FileReader();
        reader.onload = e => {
            const wb = XLSX.read(e.target.result, {type: 'binary'});
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const template = document.getElementById("waMsg").value;
            raw.forEach((row, i) => {
                const phone = row.phone || row.mobile || row['__EMPTY'];
                const msg = template.replace("{name}", row.name).replace("{fee}", row.fee);
                setTimeout(() => window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`, '_blank'), i * 3000);
            });
        };
        reader.readAsBinaryString(input.files[0]);
    }

    function loadAtt() {
        const b = document.getElementById("attBatch").value;
        const filt = b ? students.filter(s => s.batch === b) : students;
        document.getElementById("atList").innerHTML = filt.map(s => `
            <div class="flex justify-between items-center p-4 bg-white/5 rounded-xl border-l-2 border-indigo-500">
                <span class="text-xs font-black uppercase text-white">${s.name}</span>
                <input type="checkbox" class="w-6 h-6 accent-indigo-500" data-id="${s.id}" checked>
            </div>`).join("");
    }

    function nav(t, b) { document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active-tab")); document.getElementById("t-"+t).classList.add("active-tab"); }
    function delSt(id) { if(confirm("Confirm deletion of student record?")) { const tx = db.transaction("st", "readwrite"); tx.objectStore("st").delete(id); tx.oncomplete = () => sync(); } }
    function masterReset() { if(confirm("⚠️ WIPE ALL DATA?")) { indexedDB.deleteDatabase("MalhotraERP_v17_Pro"); location.reload(); } }
</script>
</body>
                </html>
    
