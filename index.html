<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexa EduMaster - MALHOTRA CLASSES</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
        }
        body.dark-mode {
            --primary: #818cf8; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--text); margin: 0; padding-bottom: 70px; }
        
        /* Glassmorphism Header */
        header {
            background: rgba(99, 102, 241, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px; text-align: center; border-bottom: 1px solid var(--primary);
        }
        .branding { font-size: 0.8rem; color: var(--primary); font-weight: bold; }

        /* Trial Lock Overlay */
        #lock-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }

        /* 4-Tab Navigation */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: var(--card);
            display: flex; justify-content: space-around; padding: 10px 0;
            border-top: 1px solid #ddd; z-index: 1000;
        }
        .nav-item { cursor: pointer; text-align: center; font-size: 0.8rem; flex: 1; }
        .nav-item i { font-size: 1.5rem; display: block; }
        .nav-item.active { color: var(--primary); }

        .container { padding: 15px; max-width: 800px; margin: auto; }
        .card { 
            background: var(--card); border-radius: 15px; padding: 15px; 
            margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary);
        }
        .search-box { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd;
            margin-bottom: 15px; background: var(--card); color: var(--text);
        }
        .btn { 
            padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; 
            font-weight: bold; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-call { background: #22c55e; color: white; }
        .btn-del { background: #ef4444; color: white; }
        .btn-wa { background: #25d366; color: white; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="lock-screen">
    <h2>Trial Expired or Clock Tampered!</h2>
    <p>Please enter Master Key to continue.</p>
    <input type="password" id="master-key-input" placeholder="Enter Key...">
    <button class="btn" style="background:var(--primary); color:white; margin-top:10px;" onclick="unlockApp()">Unlock</button>
</div>

<header>
    <div style="display:flex; justify-content: space-between; align-items:center;">
        <button onclick="toggleMode()" class="btn"><i class="fas fa-moon"></i></button>
        <div>
            <h3 style="margin:0;">MALHOTRA CLASSES</h3>
            <small>Sant Nagar Burari, Delhi-84</small>
        </div>
        <div style="display:flex; gap:10px;">
            <label class="btn" style="background:#22c55e; color:white;">
                <i class="fas fa-file-excel"></i>
                <input type="file" hidden onchange="importExcel(this)" accept=".xlsx, .xls, .json">
            </label>
            <button onclick="exportData()" class="btn" style="background:var(--primary); color:white;"><i class="fas fa-download"></i></button>
            <button onclick="masterReset()" class="btn btn-del"><i class="fas fa-power-off"></i></button>
        </div>
    </div>
    <div class="branding">Powered by Khagesh ai-nexa</div>
</header>

<div class="container">
    <input type="text" id="globalSearch" class="search-box" placeholder="Search by Name, Batch, or Subject..." oninput="sync()">

    <div id="home-tab" class="tab-content">
        <h4><i class="fas fa-users"></i> Students List</h4>
        <div id="student-list"></div>
    </div>

    </div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="showTab('home')"><i class="fas fa-home"></i>Home</div>
    <div class="nav-item" onclick="showTab('admission')"><i class="fas fa-user-plus"></i>Admission</div>
    <div class="nav-item" onclick="showTab('attendance')"><i class="fas fa-calendar-check"></i>Attendance</div>
    <div class="nav-item" onclick="showTab('fees')"><i class="fas fa-file-invoice-dollar"></i>Fees</div>
</nav>

<script>
    const CLIENT_NAME = "MALHOTRA CLASSES (ACCOUNTS VILLA)"; [cite: 2026-02-01]
    const MASTER_KEY = "Permanentkey63793119"; [cite: 2026-01-22]
    let db;

    // Database Init with Persistence [cite: 2026-01-31]
    const request = indexedDB.open("NexaEduDB_Malhotra", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("st", { keyPath: "id" });
        db.createObjectStore("config", { keyPath: "key" });
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        checkTrial();
        sync();
    };

    // 7-Day Trial & Clock Protection [cite: 2026-02-01]
    async function checkTrial() {
        const now = new Date().getTime();
        const tx = db.transaction("config", "readwrite");
        const store = tx.objectStore("config");
        
        let startDate = await new Promise(r => store.get("start_date").onsuccess = e => r(e.target.result));
        let lastVisit = await new Promise(r => store.get("last_visit").onsuccess = e => r(e.target.result));

        if (!startDate) {
            store.put({ key: "start_date", val: now });
            store.put({ key: "last_visit", val: now });
            return;
        }

        // Anti-Tamper: If system time is behind last visit
        if (now < lastVisit.val) {
            document.getElementById('lock-screen').style.display = 'flex';
        }
        
        // 7 Day Trial check
        if (now - startDate.val > 7 * 24 * 60 * 60 * 1000) {
            let isUnlocked = await new Promise(r => store.get("unlocked").onsuccess = e => r(e.target.result));
            if (!isUnlocked) document.getElementById('lock-screen').style.display = 'flex';
        }
        
        store.put({ key: "last_visit", val: now });
    }

    function unlockApp() {
        if (document.getElementById('master-key-input').value === MASTER_KEY) {
            db.transaction("config", "readwrite").objectStore("config").put({ key: "unlocked", val: true });
            document.getElementById('lock-screen').style.display = 'none';
        } else { alert("Wrong Master Key!"); }
    }

    // Direct Excel Import [cite: 2026-02-01]
    async function importExcel(input) {
        const file = input.files[0];
        const reader = new FileReader();
        const ext = file.name.split('.').pop().toLowerCase();

        reader.onload = async (e) => {
            let students = [];
            if (ext === 'xlsx' || ext === 'xls') {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                students = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            } else {
                students = JSON.parse(e.target.result);
            }

            const tx = db.transaction("st", "readwrite");
            students.forEach(s => {
                if(!s.id) s.id = Date.now() + Math.random();
                if(!s.date) s.date = new Date().toISOString().split('T')[0];
                tx.objectStore("st").put(s);
            });
            tx.oncomplete = () => { alert("Import Successful!"); sync(); };
        };
        reader.readAsBinaryString(file);
    }

    // Sync UI with Multi-Filter [cite: 2026-02-01]
    function sync() {
        const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
        const list = document.getElementById('student-list');
        list.innerHTML = "";

        db.transaction("st").objectStore("st").getAll().onsuccess = (e) => {
            const students = e.target.result;
            students.filter(s => 
                s.name.toLowerCase().includes(searchTerm) || 
                s.batch.toLowerCase().includes(searchTerm) || 
                s.cls.toLowerCase().includes(searchTerm)
            ).forEach(s => {
                list.innerHTML += `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${s.name} (${s.cls})</b>
                            <span style="font-size:0.8rem; color:gray;">Joined: ${s.date}</span>
                        </div>
                        <p style="margin:5px 0;">Batch: ${s.batch} | Fee: â‚¹${s.fee}</p>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <a href="tel:${s.phone}" class="btn btn-call"><i class="fas fa-phone"></i> Call</a>
                            <button onclick="deleteStudent(${s.id})" class="btn btn-del"><i class="fas fa-trash"></i></button>
                            <button onclick="sendBulkWA('${s.phone}', '${s.name}')" class="btn btn-wa"><i class="fab fa-whatsapp"></i> Reminder</button>
                        </div>
                    </div>
                `;
            });
        };
    }

    function deleteStudent(id) {
        if(confirm("Are you sure?")) {
            db.transaction("st", "readwrite").objectStore("st").delete(id).onsuccess = () => sync();
        }
    }

    function masterReset() {
        if(confirm("MASTER RESET: This will delete ALL data. Continue?")) {
            indexedDB.deleteDatabase("NexaEduDB_Malhotra");
            location.reload();
        }
    }

    function toggleMode() { document.body.classList.toggle('dark-mode'); }
    function showTab(tab) { /* Tab switching logic */ }
</script>
</body>
</html>
